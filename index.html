<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>FriendTimeKeeper</title>
<meta name="theme-color" content="#0b101c">
<link rel="manifest" href="manifest.webmanifest">
<link rel="icon" type="image/png" href="favicon.png">
<style>
:root{--bg:#0b101c;--card:#0f1726;--card2:#0e1a2c;--text:#eaf1ff;--muted:#9fb0d1;--border:rgba(255,255,255,.12);--ok:#10b981;--warn:#f59e0b;--no:#ef4444}
*{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial}
.header{position:sticky;top:0;background:#0b101cdf;backdrop-filter:blur(6px);border-bottom:1px solid var(--border);padding:12px 14px;display:flex;gap:10px;align-items:center;justify-content:space-between}
.brand{display:flex;gap:10px;align-items:center;font-weight:800}
.btn{padding:12px 14px;border-radius:14px;border:1px solid var(--border);background:#13233d;color:var(--text);font-weight:700}
.btn.primary{background:linear-gradient(180deg,#2291ff,#1c7be0);border:none}
.page{padding:12px 14px;display:grid;gap:14px;max-width:820px;margin:0 auto}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
.list{display:grid;gap:10px}.friend{display:grid;grid-template-columns:1fr auto;gap:10px;padding:12px;border:1px solid var(--border);border-radius:14px;background:#0e1a2c}
.name{font-weight:800}.muted{color:var(--muted);font-size:12px}.badge{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0f1728;font-size:12px}
.pill{display:inline-block;padding:6px 10px;border-radius:999px;border:1px solid var(--border);font-size:12px}
.pok{background:rgba(16,185,129,.9);color:#031a12}.pwarn{background:rgba(245,158,11,.9);color:#3b2502}.pno{background:rgba(239,68,68,.9);color:#3b0606}
.row{display:flex;gap:8px;flex-wrap:wrap}.input{width:100%;padding:14px;border-radius:14px;border:1px solid var(--border);background:#0f1726;color:var(--text)}
.grid2{display:grid;gap:10px;grid-template-columns:1fr} @media(min-width:680px){.grid2{grid-template-columns:1fr 1fr}}
.install{position:sticky;bottom:0;background:#0c1222f2;border-top:1px solid var(--border);padding:10px 14px;display:none;gap:10px;align-items:center;justify-content:space-between}
.footer{color:var(--muted);font-size:12px;text-align:center;padding:12px}
</style>
</head>
<body>
<div class="header">
  <div class="brand"><img id="appIcon" src="icon-192.png" width="28" height="28" style="border-radius:8px;border:1px solid var(--border)"> FriendTimeKeeper</div>
  <button id="shareBtn" class="btn">Share</button>
</div>

<div class="page">
  <div class="card">
    <div style="font-weight:800">Your Friends</div>
    <div class="muted">Mobile cards • Stored on your device</div>
    <div id="friends" class="list" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div style="font-weight:800">Add Friend</div>
    <div class="grid2" style="margin-top:8px">
      <input id="name" class="input" placeholder="Name (e.g., Sam)">
      <input id="tzInput" class="input" list="tzList" placeholder="Timezone (e.g., Australia/Brisbane, Tokyo, London)">
      <datalist id="tzList"></datalist>
      <input id="notes" class="input" placeholder="Notes: city, platform, etc.">
      <button id="addBtn" class="btn primary">Add</button>
    </div>
  </div>

  <div class="card">
    <div style="font-weight:800">Planner</div>
    <div class="grid2" style="margin-top:8px">
      <select id="multi" class="input" multiple style="min-height:140px"></select>
      <div style="display:grid;gap:8px;grid-template-columns:1fr 1fr">
        <input id="awakeStart" class="input" type="time" value="08:00">
        <input id="awakeEnd" class="input" type="time" value="22:00">
        <button id="planBtn" class="btn">Find Overlaps</button>
      </div>
    </div>
    <div id="plan" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <div style="font-weight:800">Settings</div>
    <div class="grid2">
      <select id="iconStyle" class="input">
        <option value="classic">Classic clock hands</option>
        <option value="digital">Digital clock</option>
      </select>
    </div>
  </div>

  <div class="footer">Created by <strong>@Shade_Kn1ght</strong> • Your timezone: <span id="myTZ"></span></div>
</div>

<div id="installBar" class="install">
  <div class="muted">Install for full‑screen & offline</div>
  <button id="installBtn" class="btn primary">Install</button>
</div>

<script>
// SW + fast install bar
if('serviceWorker' in navigator){ addEventListener('load',()=>navigator.serviceWorker.register('./sw.js')); }
let dp=null; const bar=document.getElementById('installBar');
addEventListener('beforeinstallprompt',e=>{e.preventDefault(); dp=e; bar.style.display='flex';});
document.getElementById('installBtn').onclick=async()=>{ if(!dp){alert('Use Chrome menu (⋮) → Install app.');return;} dp.prompt(); await dp.userChoice; dp=null; bar.style.display='none'; };

// Share
document.getElementById('shareBtn').onclick=async()=>{ const url=location.href, text='Install FriendTimeKeeper to track friends across time zones:'; if(navigator.share){try{await navigator.share({title:'FriendTimeKeeper',text,url});}catch(e){}} else {await navigator.clipboard?.writeText(url); alert('Link copied: '+url);} };

// Data
const LS='ftk:data:v1', LS_ICON='ftk:iconStyle';
let state=JSON.parse(localStorage.getItem(LS)||'null')||[{id:uid(),name:'Sophie',tz:'Europe/London',notes:'London, UK'},{id:uid(),name:'Lucas',tz:'America/Sao_Paulo',notes:'São Paulo, Brazil'},{id:uid(),name:'Aiko',tz:'Asia/Tokyo',notes:'Tokyo, Japan'}]; save(state);
function uid(){return Math.random().toString(36).slice(2,10);}
function save(v){localStorage.setItem(LS,JSON.stringify(v)); render(); fillMulti();}
function fmt(d,tz){return new Intl.DateTimeFormat(undefined,{hour:'2-digit',minute:'2-digit',hour12:false,timeZone:tz}).format(d);}
function hour(d,tz){return Number(new Intl.DateTimeFormat('en-GB',{hour:'2-digit',hour12:false,timeZone:tz}).format(d));}
function status(h){if(h>=8&&h<22)return['Awake','pok']; if((h>=6&&h<8)||h>=22)return['Maybe','pwarn']; return['Asleep','pno'];}
function esc(s){return (s||'').replace(/[&<>\"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;','\\'':'&#39;'}[c]));}
function offsetStr(tz){ const now=new Date(); const p=new Intl.DateTimeFormat('en-US',{timeZone:tz,timeZoneName:'shortOffset'}).formatToParts(now); const t=p.find(x=>x.type==='timeZoneName'); return t ? t.value.replace('GMT','UTC') : 'UTC±0'; }

// Render
const friendsEl=document.getElementById('friends'), myTZ=document.getElementById('myTZ');
function render(){ myTZ.textContent=Intl.DateTimeFormat().resolvedOptions().timeZone;
  const now=new Date(); friendsEl.innerHTML='';
  const sorted=[...state].sort((a,b)=>{const ha=hour(now,a.tz),hb=hour(now,b.tz); return ha===hb? a.name.localeCompare(b.name): ha-hb;});
  sorted.forEach(f=>{ const [lab,cls]=status(hour(now,f.tz));
    const el=document.createElement('div'); el.className='friend';
    el.innerHTML=`<div><div class="name">${esc(f.name)}</div><div class="muted">${esc(f.notes||'')}</div>
    <div class="row" style="margin-top:6px"><span class="badge">${esc(f.tz)}</span><span class="badge">${offsetStr(f.tz)}</span><span class="badge">${fmt(now,f.tz)}</span></div></div>
    <div style="display:grid;gap:8px;align-content:start"><span class="pill ${cls}" style="text-align:center">${lab}</span>
    <button class="btn" data-a="copy" data-id="${f.id}">Copy</button><button class="btn" data-a="del" data-id="${f.id}" style="background:#3a1420;border-color:#63202b">Remove</button></div>`;
    friendsEl.appendChild(el);
  });
  friendsEl.querySelectorAll('button').forEach(b=>b.onclick=e=>{ const id=e.currentTarget.dataset.id, a=e.currentTarget.dataset.a;
    if(a==='del'){ state=state.filter(x=>x.id!==id); save(state); }
    if(a==='copy'){ const f=state.find(x=>x.id===id); navigator.clipboard?.writeText(fmt(new Date(),f.tz)+' ('+f.tz+')'); e.currentTarget.textContent='Copied!'; setTimeout(()=>e.currentTarget.textContent='Copy',900); }
  });
}

// Add friend using datalist input
document.getElementById('addBtn').onclick=()=>{
  const nm=document.getElementById('name').value.trim();
  const tz=document.getElementById('tzInput').value.trim();
  const nt=document.getElementById('notes').value.trim();
  if(!nm||!tz) return;
  state.push({id:uid(),name:nm,tz,notes:nt});
  document.getElementById('name').value=''; document.getElementById('notes').value=''; document.getElementById('tzInput').value='';
  save(state);
};

// Planner
const multi=document.getElementById('multi'), awakeStart=document.getElementById('awakeStart'), awakeEnd=document.getElementById('awakeEnd'), plan=document.getElementById('plan'), planBtn=document.getElementById('planBtn');
function fillMulti(){ multi.innerHTML=''; state.forEach(f=>{ const o=document.createElement('option'); o.value=f.id; o.textContent=f.name+' — '+f.tz; multi.appendChild(o); }); }
function findOverlaps(ids,start='08:00',end='22:00'){ const chosen=state.filter(f=>ids.includes(f.id)); if(chosen.length<2)return[]; const now=new Date(); const [sH,sM]=start.split(':').map(Number), [eH,eM]=end.split(':').map(Number); const slots=[]; for(let step=0;step<=48;step++){ const st=new Date(now.getTime()+step*30*60000), en=new Date(st.getTime()+60*60000); const ok=chosen.every(fr=>{ const h1=hour(st,fr.tz), m1=Number(new Intl.DateTimeFormat('en-GB',{minute:'2-digit',timeZone:fr.tz}).format(st)), h2=hour(en,fr.tz), m2=Number(new Intl.DateTimeFormat('en-GB',{minute:'2-digit',timeZone:fr.tz}).format(en)); const sOK=(h1>sH||(h1===sH&&m1>=sM)), eOK=(h2<eH||(h2===eH&&m2<=eM)); return sOK&&eOK; }); if(ok) slots.push(st);} return slots.slice(0,10); }
planBtn.onclick=()=>{ const ids=Array.from(multi.selectedOptions).map(o=>o.value); const s=awakeStart.value, e=awakeEnd.value; const slots=findOverlaps(ids,s,e); if(!slots.length){ plan.innerHTML='<div class="muted">No overlaps in the next 24h.</div>'; return; } plan.innerHTML=slots.map(dt=>{ const lines=ids.map(id=>{ const f=state.find(x=>x.id===id); return `<span class="badge">${f.name}: ${fmt(dt,f.tz)} (${f.tz})</span>`; }).join(' '); return `<div class="card" style="padding:10px">${lines}<div class="muted" style="margin-top:6px">Base slot: ${new Date(dt).toLocaleString()}</div></div>`; }).join(''); };

// Datalist population with aliases for easier search
const tzInput=document.getElementById('tzInput'); const tzList=document.getElementById('tzList');
const aliases=[
  ['Australia/Brisbane',['brisbane','qld','queensland','australia']],
  ['Australia/Sydney',['sydney','nsw','new south wales','australia']],
  ['Australia/Melbourne',['melbourne','vic','victoria','australia']],
  ['Australia/Perth',['perth','wa','western australia','australia']],
  ['Europe/London',['london','uk','england','britain']],
  ['Europe/Paris',['paris','france']],
  ['Europe/Berlin',['berlin','germany','de']],
  ['Asia/Tokyo',['tokyo','japan']],
  ['Asia/Singapore',['singapore','sg']],
  ['America/New_York',['new york','nyc','usa','us','america','eastern']],
  ['America/Los_Angeles',['los angeles','la','usa','pacific']],
  ['America/Chicago',['chicago','usa','central']],
  ['America/Denver',['denver','usa','mountain']],
  ['America/Sao_Paulo',['sao paulo','brazil','br']],
  ['America/Mexico_City',['mexico','mexico city']],
  ['Africa/Johannesburg',['johannesburg','south africa','za']],
  ['Asia/Dubai',['dubai','uae','united arab emirates']],
  ['Asia/Kolkata',['kolkata','india','in']],
  ['Pacific/Auckland',['auckland','new zealand','nz']],
  ['UTC',['utc','gmt','z']]
];
function populateDatalist(){
  tzList.innerHTML='';
  const all = (Intl.supportedValuesOf? Intl.supportedValuesOf('timeZone') : []).map(z=>[z,[z.toLowerCase()]]);
  const merged = [...new Map([...aliases, ...all].map(([k,v])=>[k, v]))];
  merged.forEach(([zone,keys])=>{
    const opt=document.createElement('option'); opt.value=zone; opt.label=zone; tzList.appendChild(opt);
  });
  // quick helper: when user types a city alias, autocomplete shows the zone
  tzInput.addEventListener('input', ()=>{
    const q = tzInput.value.trim().toLowerCase();
    const hit = merged.find(([zone,keys])=> zone.toLowerCase()===q || keys.some(k=>k.includes(q)));
    if(hit) tzInput.setAttribute('value', hit[0]);
  });
}
function applyIcon(){ const v=localStorage.getItem('ftk:iconStyle')||'classic'; document.getElementById('iconStyle').value=v; document.getElementById('appIcon')?.setAttribute('src', v==='digital'?'icon-digital-192.png':'icon-192.png'); }
function init(){ populateDatalist(); applyIcon(); render(); fillMulti(); setInterval(render,30000);
  const standalone = window.matchMedia('(display-mode: standalone)').matches || navigator.standalone; if(standalone) bar.style.display='none';
}
init();
</script>
</body></html>
